# 커널 메시지 출력

## ⦁ printk() 함수

`printk()` 함수는 디바이스 드라이버를 작성하고 테스트할 때 가장 편하고 강력한 디버깅 도구다. 사용 방법은 `printf()` 함수와 유사하지만, 커널의 메시지를 출력하고 관리할 수 있는 특성이 있다.
- 메시지 기록 관리를 위한 로그 레벨의 지정
- 원형 큐 구조의 관리
- 출력 디바이스의 다중 지정

- **사용 가능한 상수 선언문과 의미**

| 상수 선언문 | 의미 |
|:---:|:---:|
| #define KERN_EMERG | "<0>" /* 시스템이 동작하지 않는다. */ |
| #define KERN_ALERT | "<1>" /* 항상 출력한다. */ |
| #define KERN_CRIT | "<2>" /* 치명적인 정보 */ |
| #define KERN_ERR | "<3>" /* 오류 정보 */ |
| #define KERN_WARING | "<4>" /* 경고 정보 */ |
| #define KERN_NOTICE | "<5>" /* 정상적인 정보 */ |
| #define KERN_INFO | "<6>" /* 시스템 정보 */ |
| #define KERN_DEBUG | "<7>" /* 디버깅 정보 */ |

### - 원형 큐 구조 관리
커널 메시지는 콘솔 디바이스로 바로 출력되지 않고, 커널 내부에 있는 원형 큐 형식의 로그 버퍼러는 저장 공간에 저장된다. 이 로그 버퍼의 크기는 CONFIG_LOG_BUF_SHIFT 값으로 지정되는데, 2의 승수로 크기를 표햔한다. 이 값은 include/config/log/buf/shift.h 에 정의되어 잇는데, 디폴트 값이 14이므로 로그 버퍼의 크기는 16,384바이트이다.

커널 메시지를 저장하는 로그 버퍼는 출력하는 콘솔 디바이스와 데이터를 기록하는 로그 프로그램에 연결되어 있다. 그래서 `printk()` 함수에 의해 로그 버퍼에 저장되는 속도보다 데이터를 가져가는 속도가 느려서 로그 버퍼의 크기를 초과하면 가장 오래된 데이터가 손실된다.

### - 로그 버퍼와 콘솔
리눅스 시스템에서는 다양한 방법으로 시스템에 명령을 입력한다. 모니터와 키보드로 입력할 수도 있고, telent과 같은 방식으로 다른 시스템에서 로그인하여 입력할 수 있다. X시스템 같은 경우에는 여러 개의 가상 터미널 창을 띄울 수 있다. 각 터미널은 원격지가 되엇든 자신의 PC가 되었든 동일한 권한과 기능을 수행할 수 있기 때문에 커널 입장에서는 어떤 장치에 커널 메시지를 출력해야 할지 모른다. 그러므로 커널 메시지를 출력할 장치를 그냥 콘솔이라 한다.

## ⦁ 커널 메시지 관리 데몬
커널 메시지는 콘솔을 통해 관리자에게 알려주지만, 동시에 다음과 같이 특별한 데몬 프로그램에서 기록하고 관리한다.
- klogd : 커널에서 발생하는 메시지를 기록하고 관리한다.
- syslogd : 커널에서 발생하는 메시지와 응용 프로그램에서 요청한 시스템 정보를 기록하고 관리한다.

이 두 데몬이 리눅스 시스템에서 동작하고 있으면 커널 메시지는 /var/log/message 파일에 모두 기록된다. 콘솔의 로그 레벨은 부팅 시 KERN_DEBUG 레벨로 설정된다. 너무 많은 메시지가 발생하여 전체를 출력하는 것이 문제가 된다면 klogd 데몬을 죽이고, -c 옵션을 이용해 재설정하면 되는데, 자세한 내용은 맨페이지에서 klogd에 관련된 도움말을 참조하기 바란다. 콘솔 레벨은 커널에서 폴트가 발생하면 자동적으로 KERN_DEBUG 레벨로 설정된다.

## ⦁ dmesg 명령
로그 버퍼에 기록된 내용을 보려면 dmesg 명령을 사용한다. 이 명령은 원형 큐 버퍼에 기록된 내용을 보여준다. 로그 버퍼에 기록된 내용이 모두 콘솔에 출력한 상태고, 커널 메시지 관리 데몬에 의해 /var/log/messages에 기록되었다 하더라도 원형 큐의 구조상 최근에 발생한 커널 메시지가 로그 버퍼에 남는다. dmesg 명령은 이런 특성을 이용해 가장 최근에 커널에서 발생한 커널 메시지를 출력한다.

## ⦁ /proc/kmsg
커널에서 메시지가 발생할 때마다 출력하고 싶다면 콘솔을 보려는 터미널로 변경해야 한다. 그러나 이 방법은 어렵기도 하거니와 관련 프로그램을 작성해야 한다. /proc/kmsg 파일을 쓰면 커널 메시지가 발생할 때 즉시 출력하고, 관찰하고 싶다면 다음 명령을 실행한다.
```bash
cat /proc/kmsg
```
그리고 출력을 중지하고 싶으면 CRTL-C 키를 눌러 프로그램을 종료한다.