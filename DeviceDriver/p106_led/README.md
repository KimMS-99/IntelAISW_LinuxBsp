# `led.c`와 `led_KMS.c`의 차이점 분석

`p106_led` 폴더에 있는 `led.c`와 `led_KMS.c` 두 파일은 LED와 Key(스위치)의 GPIO를 제어하는 커널 모듈이라는 공통점이 있지만, **GPIO 자원을 초기화하고 해제하는 방식과 타이밍**에서 중요한 차이가 있다.

---

## 1. `led.c`의 동작 방식

`led.c`는 일반적인 디바이스 드라이버와 유사하게 동작한다. 모듈이 커널에 적재된 동안 필요한 하드웨어 자원을 계속 점유하고, 모듈이 제거될 때 자원을 해제한다.

-   **`led_init` (모듈 적재 시)**
    1.  LED와 Key에 연결된 모든 GPIO 핀을 초기화한다. (`gpioLedInit`, `gpioKeyInit`).
    2.  Key의 현재 상태를 읽어온다. (`gpioKeyGet`).
    3.  읽어온 Key 값에 따라 LED의 상태를 설정한다. (`gpioLedSet`).
    4.  **GPIO 자원을 해제하지 않고, 모듈이 활성화된 동안 계속 점유합니다.**

-   **`led_exit` (모듈 제거 시)**
    1.  모든 LED를 끈다. (`gpioLedSet(0x00)`).
    2.  `led_init`에서 할당했던 LED와 Key 관련 GPIO 자원을 모두 해제한다. (`gpioLedFree`, `gpioKeyFree`).

### `led.c` 특징 요약
- 모듈이 적재된 동안 계속해서 GPIO 자원을 점유한다.
- LED는 모듈 적재 시점의 Key 상태를 계속 표시하고 유지한다.
- 표준적인 커널 모듈의 자원 관리 방식을 따른다.

---

## 2. `led_KMS.c`의 동작 방식

`led_KMS.c`는 `init`과 `exit` 함수가 실행되는 특정 시점에만 하드웨어 자원을 잠깐 사용하고 즉시 반납하는 독특한 구조를 가진다.

-   **`led_init` (모듈 적재 시)**
    1.  LED와 Key의 GPIO를 초기화한다.
    2.  Key의 상태를 읽어온다.
    3.  **읽어온 직후, Key와 LED의 GPIO 자원을 바로 해제합니다 (`gpioKeyFree`, `gpioLedFree`).**
    4.  실제로 LED를 켜는 코드는 주석 처리되어 있어, 모듈 적재 시에는 아무런 동작도 하지 않는 것처럼 보인다.

-   **`led_exit` (모듈 제거 시)**
    1.  **다시 LED와 Key의 GPIO를 초기화합니다.**
    2.  Key 상태를 읽어온다.
    3.  읽어온 Key 값으로 LED를 켠다. (`gpioLedSet`).
    4.  **다시 LED와 Key의 GPIO 자원을 즉시 해제합니다.**

### `led_KMS.c` 특징 요약
- `init`, `exit` 함수가 실행되는 순간에만 잠깐 GPIO 자원을 할당했다가 바로 해제한다.
- 모듈이 적재된 상태에서는 GPIO 자원을 점유하지 않는다.
- 모듈을 제거할 때 잠깐 LED가 켜졌다가 꺼지는 일회성 동작을 수행한다.
- 자원 관리 측면에서 비효율적이며, 일반적인 드라이버의 동작 방식과는 거리가 있다.

---

## 3. 핵심 차이점 비교

| 구분 | `led.c` | `led_KMS.c` |
| :--- | :--- | :--- |
| **GPIO 점유 방식** | 모듈이 적재된 동안 **계속 점유** | `init`, `exit` 함수 실행 시에만 **잠깐 점유 후 해제** |
| **`init` 시 동작** | Key 상태를 읽어 LED를 켜고, 그 상태를 **유지** | Key 상태를 읽지만 LED는 켜지 않고, GPIO **자원 즉시 해제** |
| **`exit` 시 동작** | LED를 끄고 GPIO **자원 해제** | GPIO를 다시 잡고 Key 상태를 읽어 LED를 **잠깐 켰다가** 자원 해제 |
| **주된 목적** | 모듈 로드 시점의 스위치 상태를 지속적으로 표시 | 모듈 로드/언로드 시점에 스위치 상태를 확인하여 일회성 동작 수행 |
